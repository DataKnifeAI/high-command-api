name: Tests
on:
  workflow_dispatch:
  push:
    branches:
    - main
    - develop
  pull_request:
    branches:
    - main
    - develop
jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
        - ubuntu-latest
        - macos-latest
        - windows-latest
        python-version:
        - '3.13'
        - '3.14'
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install -e ".[dev]"

        '
    - name: Run linters
      run: 'ruff check src tests

        mypy src --ignore-missing-imports

        '
    - name: Run tests with coverage
      run: 'pytest --cov=src --cov-report=xml --cov-report=term --cov-fail-under=80

        '
    - name: Upload coverage reports
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.14'
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install bandit safety

        '
    - name: Run security checks
      run: 'bandit -r src -f json -o bandit-report.json || true

        safety check --json || true

        '
  push-to-gitlab:
    name: Push to GitLab
    runs-on: ubuntu-latest
    needs:
    - test
    if: always() && needs.test.result == 'success'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Push to GitLab
      env:
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      run: 'git config user.name "GitHub Actions"

        git config user.email "actions@github.com"

        git push https://oauth2:${GITLAB_TOKEN}@gitlab.com/dk-raas/dkai/high-command/high-command-api.git HEAD:main --force
        || echo "GitLab push failed"'
